# <ins>Database Schema</ins>

## 1. Overview of Psyanim Database Schema

`Psyanim 2` is designed primarily for online `psychology` and `cognitive science` experiments, so an important part of each experiment is data gathering and recording.

As `PsyanimApp` is responsible solely for simulating and rendering the 2D scenes we create, all of the data gathering and recording responsibilities are handled by the `PsyanimJsPsychPlugin`.

The data generated by `Psyanim 2` exists in the form of a NoSQL database: `collections` of `JSON documents` where each `document` contains a single `JSON object` as it's root.

These `Psyanim 2 databases` can exist locally as `flat files` or in the `cloud` via any database provider.

By default, `Psyanim 2` has tight integration with `Google Firebase`, but a simple abstraction layer exists so support can be added for other cloud-based databases.

There are 5 top-level collections in the database:

- `trial-metadata`
- `animation-clips`
- `state-logs`
- `session-logs`
- `jspsych-experiment-data`

Every `document` in these `collections` contains a `JSON object` as its root, and within each top-level object are two fields: `data` and a `timestamp`.

The `data` field of the top-level JSON object contains the actual data for that specific document type.

The `trial-metadata` collection contains a document for every trial that is run using the `PsyanimJsPsychPlugin`.

The `animation-clips` collection contains a document for every entity whose `position`, `rotation`, and any other time-varying property was recorded.

The `state-logs` collection retains a configurable history of `agent states` from the AI state machines which control the AI agents.

The `session-logs` collection contains all of the `PsyanimDebug logging output`.

The `jspsych-experiment-data` contains the contents of the `jsPsych.data` structure captured by any trial that had a `PsyanimJsPsychDataWriterExtension` added to it.

In the sections that follow, each collection is described in more detail.

## 2. `trial-metadata` collection

The `trial-metadata` collection documents all contain scene specific data, including:

- a `sceneKey` identifying the unique scene name for the trial
- an `agentMetadata` array, containing metadata for each agent, possibly including user-defined custom parameters for each agent
- some `sceneParameters`, some of which are user-defined and some are defined by `psyanim2`
- a `trialNumber` integer that uniquely identifies that trial within all of the trials run with the `PsyanimJsPsychPlugin` for that experiment
- a user-defined `userID` string
- a user-defined `experimentName` string

Any entity in `psyanim2` can have it's position and orientation saved over time as a document in the `animation-clips` collection.

Each object in the `agentMetadata` array can potentially have an `animationClipId`, which is a document ID for a document in the `animation-clips` containing the `animation data` for that `agent`.

The following is a sample `trial-metadata` document:

```json
{
    "data": {
        "sceneKey": "Wander Test",
        "agentMetadata": [
            {
                "animationClipId": "4b2bc253-c434-4b8c-8aab-00f92eec36b9",
                "name": "agent",
                "initialPosition": {
                    "x": 741.4686846915806,
                    "y": 519.5448651348128
                },
                "matterOptions": {
                    "name": "agent",
                    "isSleeping": false,
                    "isSensor": false,
                    "collisionFilter": {
                        "category": 1,
                        "mask": 13
                    }
                },
                "shapeParams": {
                    "shapeType": "PSYANIM_SHAPE_TRIANGLE",
                    "altitude": 32,
                    "color": 16761035,
                    "textureKey": "wanderTestTexture",
                    "base": 16
                }
            }
        ],
        "sceneParameters": [
            {
                "parameterType": "scene",
                "parameterName": "canvasSize",
                "parameterValue": {
                    "width": 800,
                    "height": 600
                }
            },
            {
                "parameterType": "scene",
                "parameterName": "backgroundColor",
                "parameterValue": "#ffffff"
            },
            {
                "parameterType": "scene",
                "parameterName": "wrapScreenBoundary",
                "parameterValue": true
            }
        ],
        "trialNumber": 0,
        "sessionID": "bea6e389-5ae5-47f4-9235-4b221d8ff7f3",
        "userID": "Jason",
        "experimentName": "defaultExperimentName"
    },
    "time": {
        "_seconds": 1701914763,
        "_nanoseconds": 233000000
    }
}
```

## 3. `animation-clips` collection

Every document `animation-clips` collection contains a `time-series` array of `sample` objects at each timestep, with the following fields, at a minimum:

- `t`: current time
- `rotation`: orientation of the entity
- `x`: x-coordinate of the entity's position in the world
- `y`: y-coordinate of the entity's position in the world

In addition to this data, each sample can also contain custom, user-defined time-series data.

```json
{
    "data": [
        {
            "t": 0,
            "rotation": 0,
            "x": 741.4686846915806,
            "y": 519.5448651348128
        },
        {
            "t": 28,
            "rotation": -0.3394931361149034,
            "x": 742.9471888602887,
            "y": 519.0227067075969
        },
        {
            "t": 44.29999999701977,
            "rotation": -0.3346741390403061,
            "x": 744.3460539036649,
            "y": 518.5410051854006
        }
    ],
    "lastTimeModified": {
        "_seconds": 1701914763,
        "_nanoseconds": 115000000
    }
}
```

## 4. `session-logs` collection

The documents in the `session-logs` collection contain an array of user-defined and framework-level log statements output from the entire experiment.

Each object in the array has the following information:

- `msg`: the actual message that was logged
- `type`: the type can be `log`, `warn`, or `error`, just like `console.log()` in javascript
- `clientTime`: the time on the client that this message was generated

Here is an example `session-logs` collection document:

```json
{
    "data": [
        {
            "msg": [
                "load scene called with key: Wander Test"
            ],
            "type": "log",
            "clientTime": 1701914760896
        },
        {
            "msg": [
                "New wander scene created, logging state for agent: ",
                "agent"
            ],
            "type": "log",
            "clientTime": 1701914760930
        },
        {
            "msg": [
                "_angle = ",
                304.4683669002278
            ],
            "type": "log",
            "clientTime": 1701914761924
        },
        {
            "msg": [
                "_angle = ",
                363.9969997706003
            ],
            "type": "log",
            "clientTime": 1701914762944
        },
        {
            "msg": [
                "_angle = ",
                532.0378947698973
            ],
            "type": "log",
            "clientTime": 1701914763946
        },
        {
            "msg": [
                "load scene called with key: Wander Test_2"
            ],
            "type": "log",
            "clientTime": 1701914771227
        },
        {
            "msg": [
                "New wander scene created, logging state for agent: ",
                "agent_1"
            ],
            "type": "log",
            "clientTime": 1701914771256
        },
        {
            "msg": [
                "_angle = ",
                445.7914669163267
            ],
            "type": "log",
            "clientTime": 1701914772219
        },
        {
            "msg": [
                "_angle = ",
                552.2095983980269
            ],
            "type": "log",
            "clientTime": 1701914773220
        }
    ],
    "time": {
        "_seconds": 1701914780,
        "_nanoseconds": 159000000
    }
}
```

## 5. `state-logs` collection

As the AI agents transition between states in a `PsyanimFSM` state machine, it is helpful for debugging and analysis purposes to keep track of the state changes.

The `state-logs` collection can optionally be generated for any trial, and it's data is autogenerated for developers & researchers.

Example JSON coming soon...

## 6. `jspsych-experiment-data` collection

The `jspsych-experiment-data` contains the contents of the `jsPsych.data` structure captured by any trial that had a `PsyanimJsPsychDataWriterExtension` added to it.

An example of this data looks like:

```json
{
    "data": {
        "jsPsychData": "[{\"rt\":424,\"stimulus\":\"<p style='text-align:center'>Welcome to the experiment.  Press any key to begin.</p>\",\"response\":\"enter\",\"trial_type\":\"html-keyboard-response\",\"trial_index\":0,\"time_elapsed\":425,\"internal_node_id\":\"0.0-0.0\"},{\"trial_type\":\"psyanim-jsPsych-plugin\",\"trial_index\":1,\"time_elapsed\":3698,\"internal_node_id\":\"0.0-1.0\"},{\"trial_type\":\"psyanim-jsPsych-plugin\",\"trial_index\":2,\"time_elapsed\":7188,\"internal_node_id\":\"0.0-2.0\"},{\"trial_type\":\"psyanim-jsPsych-plugin\",\"trial_index\":3,\"time_elapsed\":10759,\"internal_node_id\":\"0.0-3.0\"},{\"trial_type\":\"psyanim-jsPsych-plugin\",\"trial_index\":4,\"time_elapsed\":15287,\"internal_node_id\":\"0.0-4.0\"},{\"rt\":863,\"stimulus\":\"<p style='text-align:center'>Congrats - you have completed your first experiment!  Press any key to end this trial.</p>\",\"response\":\"enter\",\"trial_type\":\"html-keyboard-response\",\"trial_index\":5,\"time_elapsed\":16151,\"internal_node_id\":\"0.0-5.0\"}]",
        "sessionID": "bea6e389-5ae5-47f4-9235-4b221d8ff7f3",
        "userID": "Jason",
        "experimentName": "defaultExperimentName"
    },
    "time": {
        "_seconds": 1701914776,
        "_nanoseconds": 880000000
    }
}
```

## 6. Expected Database Size and Transaction Costs for An Experiment

Google Firebase Firestore databases charge for document reads, writes and deletes.  Thus, when estimating the cost of running an experiment, it is helpful to have an idea of how many document reads and writes will be done per experiment.

During experiment using the `PsyanimJsPsychPlugin` or the `PsyanimJsPsychDataWriterExtension`, no documents are ever deleted, so we will not consider document deletions here.

To minimize the cost of running an experiment, we simply need to know the number of documents read and written.

Psyanim 2 is very configurable, so there are many factors which affect how much data it consumes and generates for a given experiment.

In the tables below, you'll find the relevant document types and rates at which they are read / written.

Here is the data that gets `written` to the database for every experiment:

| Document Type | Number | Optional? | Other Notes |
| ------------- | ---------------- | ----------------- | ----------- |
| Trial Metadata | 1 Per Trial | No | |
| Animation Clip | 1 Per Agent Per Trial | Yes | |
| Agent State Log | 1 Per Agent Per Trial | Yes | |
| Session Logs | 1 Per `Experiment` | Yes | There is only 1 doc per experiment that each trial writes to, with buffered writes that get flushed to firestore at a configurable frequency |
| JsPsych Experiment Data | 1 Per `Experiment` | Yes | There is only 1 doc per experiment that each trial writes to, but the write takes place for every trial that uses the `PsyanimJsPsychDataWriterExtension` |

Here is the data that gets `read` in from the database for every trial:

| Document Type | Optional? | Other Notes |
| ------------- | ------------ | ----------- |
| Trial Metadata | Yes | The PsyanimJsPsychTrialLoader uses trial collection files to determine how many trials to read from firebase |
| Animation Clip | Yes | For every trial-metadata doc configured in trial collection files, the PsyanimJsPsychTrial Loader will load every associated animation clip, 1 per agent |

It's also important to note that the `Psyanim Experiment Viewer` uses `data providers` to determine what data to pull from firebase firestore for visualization purposes.

By default, it will pull all trial documents in the `trial-metadata` collection.  This can result in an enormous amount of reads in a single `experiment viewer` session.

To limit the amount of data `Psyanim Experiment Viewer` reads from the database for each session, it's important to use a custom data-provider with server-side queries, so filtering is done on server-side rather than pulling all data to client to filter there.  More info on this can be found [here](/overview/jspsych_integration.md#_10-custom-queries-with-psyanim-cli).